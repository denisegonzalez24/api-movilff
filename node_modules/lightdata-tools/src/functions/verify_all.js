import { CustomException } from "../classes/custom_exception.js";
import { Status } from "../classes/status.js";

/**
 * bodySpec = {
 *   required: [],  // deben venir y no pueden ser null/undefined
 *   optional: [],  // pueden faltar o venir null
 * }
 */
export function verifyAll({ req, requiredParams = [], bodySpec = {} }) {
    const { required = [], optional = [] } = bodySpec;
    const faltantes = [];
    const method = String(req.method || "").toUpperCase();

    // Unificamos fuente de parámetros:
    // - GET/DELETE: chequear tanto ruta como query
    // - Otros métodos: solo ruta (como venías haciendo) + body más abajo
    const routeSource =
        method === "GET" || method === "DELETE"
            ? { ...(req.params || {}), ...(req.query || {}) }
            : (req.params || {});

    // 1) Params de ruta/query requeridos
    for (const p of requiredParams) {
        const v = routeSource[p];
        const missing =
            v === undefined ||
            v === null ||
            (typeof v === "string" && v.trim() === "");
        if (missing) {
            faltantes.push(`Parámetro de ruta o query "${p}" es obligatorio`);
        }
    }

    // GET/DELETE: solo validamos params/query; no hay body
    if (method === "GET" || method === "DELETE") {
        if (faltantes.length) {
            throw new CustomException({
                title: "Faltan parámetros",
                message: faltantes.join(", "),
                status: Status.badRequest,
            });
        }
        return;
    }

    // 2) Body (para POST/PUT/PATCH, etc.)
    const body = req.body || {};

    for (const f of required) {
        const has = Object.prototype.hasOwnProperty.call(body, f);
        if (!has || body[f] === undefined || body[f] === null) {
            faltantes.push(`Campo de body "${f}" es obligatorio`);
        }
    }
    if (faltantes.length) {
        throw new CustomException({
            title: "Faltan campos",
            message: faltantes.join(", "),
            status: Status.badRequest,
        });
    }

    // 3) Desconocidos en body
    const allowed = new Set([...required, ...optional]);
    const extras = Object.keys(body).filter((k) => !allowed.has(k));
    if (extras.length) {
        throw new CustomException({
            title: "Campos inválidos",
            message: `No se permiten: ${extras.join(", ")}`,
            status: Status.badRequest,
        });
    }
}
