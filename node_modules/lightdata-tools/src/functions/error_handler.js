import { CustomException } from "../classes/custom_exception.js";
import { Status } from "../classes/status.js";
import { logOrange, logRed } from "../functions/logs_custom.js";
/**
 * EnvÃ­a la respuesta de error apropiada y loguea, segÃºn el tipo de excepciÃ³n.
 * @param {Request}  req  â€“ para saber mÃ©todo y URL
 * @param {Response} res  â€“ para enviar la respuesta
 * @param {Error}    err  â€“ la excepciÃ³n capturada
 */
export function errorHandler(req, res, err) {
    let ex;

    if (err.isAxiosError) {
        const axiosStatus = err.response?.status || Status.badGateway;
        const axiosUrl = err.config?.url || "(URL desconocida)";
        const axiosData = err.response?.data || err.message;

        ex = new CustomException({
            title: "Error en microservicio externo",
            message: `FallÃ³ la request a ${axiosUrl}`,
            data: {
                status: axiosStatus,
                method: err.config?.method?.toUpperCase(),
                url: axiosUrl,
                response: axiosData,
            },
            status: axiosStatus >= 400 && axiosStatus < 500
                ? Status.badRequest
                : Status.internalServerError,
            stack: err.stack,
        });

        logOrange(`ðŸ›°ï¸ Axios Error (${axiosStatus}) [${req.method} ${req.originalUrl}] â†’ ${axiosUrl}:\n${JSON.stringify(axiosData, null, 2)}`
        );
    } else if (err instanceof CustomException) {
        ex = err;
        logOrange(`Error ${ex.status} ${req.method} ${req.originalUrl}: ${ex.toJsonString()}`);
    } else {
        ex = new CustomException({
            title: 'Error Interno del Servidor',
            message: err.message,
            stack: err.stack,
            status: Status.internalServerError
        });
        logRed(`Error ${ex.status} ${req.method} ${req.originalUrl}: ${ex.toJsonString()}`);
    }

    return res.status(ex.status).json(ex.toJSON());
}