// routes/_handler.js
import { performance } from 'node:perf_hooks';
import { verifyHeaders } from './verify_headers.js';
import { verifyAll } from './verify_all.js';
import { connectMySQL } from '../db_functions/connect_to_db.js';
import { logRed } from './logs_custom.js'
import { errorHandler } from './error_handler.js';
import { Status } from '../classes/status.js';
import { CustomException } from '../classes/custom_exception.js';

/**
 * @param {Object} opts
 * @param {string[]} [opts.required=[]]
 * @param {string[]} [opts.optional=[]]
 * @param {string[]} [opts.headers=[]]
 * @param {number}   [opts.status=Status.ok]
 * @param {Function} [opts.companyResolver] async ({req}) => company | null
 *   Si no se define:
 *     - Si req.user?.companyId existe -> companiesService.getById(companyId)
 *     - Si no, company = null
 * @param {Function} opts.controller async ({ req, res, company, db }) => result | { body, status }
 * @param {Function} [opts.getDbConfig] ({ company }) => dbConfig
 * @param {Function} [opts.log] async ({ req, startedAt, durationMs, data, exito, statusCode }) => {}
 * @param {Object}   [opts.pool] Instancia de pool de conexiones MySQL (mysql2)
 */
export function buildHandler({
    required = [],
    optional = [],
    headers = [],
    requiredParams = [],
    status = Status.ok,
    controller,
    companyResolver = null,
    getDbConfig = null,
    log = null,
    pool = null,
}) {
    if (typeof controller !== 'function') {
        throw new CustomException({ title: "Error de configuraci贸n", message: "buildHandler: controller debe ser una funci贸n async" });
    }

    return async (req, res) => {
        const t0 = performance.now();       // monot贸nico para duration
        const startedAt = Date.now();       // timestamp real
        let db;
        let data;
        let exito;
        try {
            verifyHeaders({ req, headers });
            verifyAll({ req, requiredParams, bodySpec: { required, optional } });

            // Resolver company
            let company = null;
            if (companyResolver) {
                company = await companyResolver({ req });
            }

            // Conexi贸n DB (si se necesita)
            if (getDbConfig) {
                const dbConfig = getDbConfig({ company });
                db = await connectMySQL(dbConfig);
            }

            // Ejecutar controlador
            const out = await controller({ req, res, company, db: db, pool });
            const hasEnvelope = out && typeof out === 'object' && 'body' in out && 'status' in out;

            const body = hasEnvelope ? out.body : out;
            const httpStatus = hasEnvelope ? out.status : status;

            data = body;
            exito = true;
            return res.status(httpStatus).json(body);
        } catch (error) {
            data = error;
            exito = false;
            return errorHandler(req, res, error);
        } finally {
            if (db) {
                try {
                    db.end();
                    const durationMs = performance.now() - t0;
                    await log({
                        req,
                        startedAt,
                        durationMs,
                        data,
                        exito,
                        statusCode: res.statusCode,
                    });
                } catch (e) {
                    logRed(e);
                }
            }
        }
    };
}