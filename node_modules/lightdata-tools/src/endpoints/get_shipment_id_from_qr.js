import { CustomException } from "../classes/custom_exception.js";

/**
 * Pide el shipmentId al micro que resuelve el QR.
 * Reenvía headers del request original, pero limpia basura de Postman.
 *
 * @param {object} params
 * @param {string} params.url                     // ej: "http://localhost:13002/api/asignaciones/get-shipment-id"
 * @param {import('axios').AxiosInstance} params.axiosInstance
 * @param {object} params.req                     // req de Express del caller
 * @param {object} params.dataQr                  // { local, did, cliente, empresa, ... }
 * @param {string} params.desde                   // deviceFrom / origen ("Autoasignado de colecta", etc.)
 * @param {number|string} params.companyId
 */
export async function getShipmentIdFromQr({
    url,
    axiosInstance,
    req,
    dataQr,
    companyId,
}) {
    const payload = {
        dataQr,
        companyId,
    };

    const forwarded = { ...req.headers };

    if (!forwarded.authorization && req.headers.Authorization) {
        forwarded.authorization = req.headers.Authorization;
    }

    const bannedHeaders = [
        "host",
        "content-length",
        "user-agent",
        "postman-token",
        "accept-encoding",
        "cache-control",
        "connection",
        "if-none-match",
        "if-modified-since",
        "upgrade-insecure-requests",
    ];
    for (const h of bannedHeaders) {
        if (h in forwarded) {
            delete forwarded[h];
        }
    }

    forwarded["content-type"] = "application/json";

    if (forwarded.authorization) {
        forwarded.Authorization = forwarded.authorization;
    }
    delete forwarded.authorization;

    let result;
    try {
        result = await axiosInstance.post(url, payload, {
            headers: forwarded,
        });
    } catch (err) {
        const status = err?.response?.status;
        const data = err?.response?.data;

        throw new CustomException({
            title: "Error al obtener el shipmentId",
            message:
                data?.message ||
                data?.error ||
                (status ? `Request failed with status code ${status}` : err.message),
            stack: err.stack,
        });
    }

    if (result.status === 200) {
        return result.data.data.shipmentId;
    } else {
        throw new CustomException({
            title: "Error al obtener el shipmentId",
            message: `Código de estado inesperado: ${result.status}`,
            stack: result.data?.stack || "",
        });
    }
}
