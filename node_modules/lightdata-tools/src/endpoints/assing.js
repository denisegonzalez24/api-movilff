import { CustomException } from "../classes/custom_exception.js";

/**
 * Envía la asignación al microservicio de asignaciones,
 * reenviando casi todos los headers originales pero limpiando
 * los que rompen (Postman / hop-by-hop / calculados por axios).
 *
 * @param {object} params
 * @param {import('axios').AxiosInstance} params.axiosInstance
 * @param {string} params.url
 * @param {object} params.dataQr
 * @param {number|string} params.driverId
 * @param {string} params.desde       // "Autoasignado de colecta", etc.
 * @param {number|string} params.companyId
 * @param {object} params.req         // req de Express del caller
 */
export async function assign({
  axiosInstance,
  url,
  dataQr,
  driverId,
  companyId,
  req,
}) {
  const payload = {
    dataQr,
    driverId,
    companyId,
  };

  const forwarded = { ...req.headers };

  if (!forwarded.authorization && req.headers.Authorization) {
    forwarded.authorization = req.headers.Authorization;
  }

  const bannedHeaders = [
    "host",
    "content-length",
    "user-agent",
    "postman-token",
    "accept-encoding",
    "cache-control",
    "connection",
    "if-none-match",
    "if-modified-since",
    "upgrade-insecure-requests",
  ];

  for (const h of bannedHeaders) {
    if (h in forwarded) {
      delete forwarded[h];
    }
  }

  forwarded["content-type"] = "application/json";

  if (forwarded.authorization) {
    forwarded.Authorization = forwarded.authorization;
  }

  delete forwarded.authorization;

  const result = await axiosInstance.post(url, payload, {
    headers: forwarded,
  });

  if (result.status !== 200) {
    throw new CustomException({
      title: "Error al asignar",
      message: `Código de estado: ${result.status}`,
      stack: result.data?.stack || "",
    });
  }

  return result.data;
}
